[#include "../../../inc/head_v2.html"/]
<link href="${base}/res/console/css/bootstrap-3.3.4.css" rel="stylesheet" type="text/css">
<link href="${base}/res/console/css/css.css" rel="stylesheet" type="text/css">
<link href="${base}/res/third/dialog/css/bootstrap-dialog.css" rel="stylesheet">
<link rel="stylesheet" href="${base}/res/css/wmesupload.css"> 
<link rel="stylesheet" type="text/css" href="/wmes/res/css/Funds.css">
<style type="text/css">
.wmes-logo{height: 60px; width: 80px;}
.r-side-container{margin-left: 80px;}
</style>
<script type="text/javascript">
	var base_root = '${base}';
</script>

<input id="btnCloseIframe" type="hidden" />
<div style="margin-left:10px;">
<div class="wmes-content" id="wmes_wraper">
    <div class="tab_wrap dis_ifafirm_condition" id="tab_wrap">
        <div class="wmes-wrap-title">
            <p>[@lang_res k='notice.target.D1'/]</p>
        </div>
            <div class="clear"></div>
            <div class="tab_wrap" id="tab_wrap">
                <!-- tab一 -->
                <form class="form-inline" style="display:block;">
                	<!--按钮 -->
                    <div>
                    	<a id="btnAdd" href="javascript:ShowFirmDialog('');" class="btn-blue-s">[@lang_res k='global.add'/]</a>
                    </div>
					<!-- 数据条数与输入框查询 -->
                    <div class="funds_keyserach_wrap">
						<p class="ifa_serach_sum" style="line-height:33px;">
							[@lang_res k='criteria.total.a'/]					
							<span class="funds_serach_digital" id="dataTotal"></span> [@lang_res k='criteria.total.b'/]
						</p> 
					 	<div style="height:33px;" class="funds_keyserach ifa_keyserach">
                       		<input type="text" class="searchCondition" id="txtIfafirmName" placeholder="[@lang_res k='notice.target.D1'/]">
                       		<span class="icon_search"></span>	
                    	</div>
			        </div>
           
                    <div>
                        <table id="infoList" border="0" cellpadding="0" cellspacing="0" class="table table-hover table-striped">
                            <tbody>
								<tr>
									<!--<th hidden class="table-head">ID</th>-->
									<th class="table-head">Logo</th>
									<th class="table-head">[@lang_res k='console.membercompanyifafirm.ifafirmname'/]</th>
									<th class="table-head">[@lang_res k='distributor.list.entityType'/]</th>
									<th class="table-head">[@lang_res k='ifafirm.list.registerNo'/]</th>
									<th class="table-head">[@lang_res k='member.info.website'/]</th>
									<th class="table-head">[@lang_res k='member.info.incorporationPlace'/]</th>
									<th class="table-head">[@lang_res k='global.operate'/]</th>
	                            </tr>                                
                            </tbody>
                        </table>
                   
		           		<nav  class="pull-right">
			                <!-- log分页 -->
			                <ul id='pagination' class="pagination pagination-sm">  
			                	
			                </ul>
			            </nav>
           				<div class="clear"></div>                      
                    </div>
                </form>               
            </div> 
                       
        </div>
        <div class="dis-mask-wrap">
        	<div class="dis-mask-contents">
        		<div class="dis-mask-mainer" id="clearDiv">
        		<div class="container-fluid pd0" id="wmes">
					<div class="tab-side container-fluid">
						<div class="tab-side-container">
							<div class="page-header mt-10">
								<h4>
									<b>[@lang_res k='console.ifafirm.detail.tab.title'/]</b>
								</h4>
							</div>
							<div class="clear"></div>
							<div>
								<form id="frm" class="form-horizontal" method="post">
								    <!--<input id="hidIfaFirmId" type="hidden" class="form-control" value="${(ifafirm.id)?if_exists}">
									<input type="hidden" id="hidEntityType" value="${(ifafirm.entityType)?if_exists}">
									<input type="hidden" id="hidIsFinancial" value="${(ifafirm.isFinancial)?if_exists}">
									<input type="hidden" id="hidCountry" value="${(ifafirm.country)?if_exists}">
									<input type="hidden" id="hidIncorporationPlace" value="${(ifafirm.incorporationPlace)?if_exists}">-->
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtCompanyNameSc" class="label-control">
												<span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.companyName'/]([@lang_res k='lang.sc'/])
											</label>
										</div>
										<div class="col-md-4">
											<input id=txtCompanyNameSc type="text" name="companyNameSc" class="form-control"
												value="">
										</div>
										<div class="col-md-2 text-right">
											<label for="txtCompanyNameTc" class="label-control">
											    <span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.companyName'/]([@lang_res k='lang.tc'/])
											</label>
										</div>
										<div class="col-md-4">
											<input id=txtCompanyNameTc name="companyNameTc" type="text" class="form-control"
												value="">
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtCompanyNameEn" class="label-control">
												<span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.companyName'/]([@lang_res k='lang.en'/])
											</label>
										</div>
										<div class="col-md-4">
											<input id=txtCompanyNameEn type="text" name="companyNameEn" class="form-control"
												value="">
										</div>
										<div class="col-md-2 text-right">
											<label for="selEntityType" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.entityType'/]
											</label>
										</div>
										<div class="col-md-4">
											<select id="selEntityType" name="entityType" class="form-control">
												<option value="">
													[@lang_res k='console.ifafirm.list.select.entityType.default'/]
												</option>
												<option value='1'>
													[@lang_res k='console.ifafirm.detail.form.select.entityType.1'/]
												</option>
												<option value='2'>
													[@lang_res k='console.ifafirm.detail.form.select.entityType.2'/]
												</option>
												<option value='3'>
													[@lang_res k='console.ifafirm.detail.form.select.entityType.3'/]
												</option>
												<option value='4'>
													[@lang_res k='console.ifafirm.detail.form.select.entityType.4'/]
												</option>
												<option value='5'>
													[@lang_res k='console.ifafirm.detail.form.select.entityType.5'/]
												</option>
											</select>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtRegisterNo" class="label-control">
												<span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.registerNo'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id="txtRegisterNo" type="text" name="registerNo" class="form-control "
												value="">
										</div>
										<div class="col-md-2 text-right">
											<label for="selIsFinancial" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.isFinancial'/]
											</label>
										</div>
										<div class="col-md-4">
											<select id="selIsFinancial" class="form-control" name="isFinancial">
												<option value=''>
													[@lang_res k='global.pleaseSelect'/]
												</option>
												<option value='1'>
													[@lang_res k='global.true'/]
												</option>
												<option value='0'>
													[@lang_res k='global.false'/]
												</option>
											</select>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtGiin" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.giin'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id=txtGiin type="text" class="form-control" name="giin" 
												 value="">
										</div>
										<div class="col-md-2 text-right">
											<label for="txtNaturePurpose" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.naturePurpose'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id="txtNaturePurpose" type="text" class="form-control" name="naturePurpose" 
												value="">
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="dtIncorporationDate" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.incorporationDate'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id='dtIncorporationDate' type="text" name="incorporationDateStr" 
										        class="laydate-icon form-control form-control-laydate" 
										        style="height: 34px; padding: 6px 12px;" 
										        onclick="laydate({istime: false, max: laydate.now(), format: 'YYYY-MM-DD'})" name="born" value="">										
										</div>
										<div class="col-md-2 text-right">
											<label for="txtIncorporationPlace" class="label-control">
												<span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.incorporationPlace'/]
											</label>
										</div>
										<div class="col-md-4">
											<select id="selIncorporationPlace" class="form-control" name="incorporationPlace">
											</select>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtRegisteredAddress" class="label-control">
												<span class="red">* </span>
												[@lang_res k='console.ifafirm.detail.form.label.registeredAddress'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id="txtRegisteredAddress" type="text" name="registeredAddress" 
												class="form-control"
												value="">
										</div>
										<div class="col-md-2 text-right">
											<label for="txtMailingAddress" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.mailingAddress'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id="txtMailingAddress" type="text" class="form-control" name="mailingAddress" 
												value="">
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="txtCountry" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.country'/]
											</label>
										</div>
										<div class="col-md-4">
										    <select id="selCountry" class="form-control" name="country">
											</select>
										</div>
										<div class="col-md-2 text-right">
											<label for="txtWebsite" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.website'/]
											</label>
										</div>
										<div class="col-md-4">
											<input id="txtWebsite" type="text" class="form-control" name="website" 
												value="">
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-2 text-right">
											<label for="imgFile" class="label-control">
												[@lang_res k='console.ifafirm.detail.form.label.companyLogo'/]
											</label>
										</div>
										<div class="col-md-10">
											<div class="upload-box upload-album"></div>
						      				<div>
						      					<img id="imgPath" style="width:180px;height:70px;" src="${base}[@user_head u='${firmLogo!}' t='f'/]" value=""/>
						      					<input type="hidden" id="firmLogo" name="firmLogo" value="${firmLogo!}" >
											</div>
				      					</div>
									</div>
									<div class="form-inline divUser">
										<div class="text-center pd10">
											<button id="btnSave" type="submit" class="btn btn-primary">
												[@lang_res k='global.save'/]
											</button>
											<a id="btnClose" class="btn btn-primary">
												[@lang_res k='global.close'/]
											</a>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
        		</div>
        	</div>
        </div>
    </div>
</div>
</div>
[#include "../../../inc/foot_v2.html"/]
<script src="${base}/res/console/js/jquery-1.11.2.min.js" type="text/javascript"></script>
<script src="${base}/res/console/js/jquery.form.js"></script>
<script src="${base}/res/console/js/jquery.pagination.js"></script>
<script src="${base}/res/console/js/bootstrap.js" type="text/javascript"></script>
<script src="${base}/res/third/jqueryui/jquery-ui.js" type="text/javascript"></script>
<script src="${base}/res/third/bootstrap/js/bootstrapValidator.js"></script>
<script src="${base}/res/third/dialog/js/bootstrap-dialog.js"></script>
<script src="${base}/res/console/js/js.js" type="text/javascript"></script>
<script src="${base}/res/third/laydate/laydate.js" type="text/javascript"></script>
<script src="${base}/res/third/layer/layer_v2.js"></script>
<script src="${base}/res/js/util.js"></script>
<script type="text/javascript" src="${base}/res/js/base.js"></script>
<script type="text/javascript" src="${base}/res/js/seajs/sea.js"></script>
<script type="text/javascript" src="${base}/res/js/config-sea.js"></script>
<script>
	seajs.use(['jquery','layer','wmes_upload'],function($){
		//页面第一次加载时选第一个类别			
		$(".upload-album").InitUploader({ 
			btntext: "[@lang_res k='notice.edit.input.addImage'/]", 
			multiple: true, 
			water: true, 
			thumbnail: true, 
			filesize: "8000",
			modulerelate:"portrait",
			successCallBack:function(filePath,orifilename){
				//$('#imgFile').val(filePath);
				//刷新预览
				$('#imgPath').attr('src',base_root+"/loadImgSrcByPath.do?filePath="+filePath);
				$('#firmLogo').val(filePath);
			}
		});
	});
</script>
<script type="text/javascript">
var grid_selector = "#infoList";
var pageSize = 10;
</script>
<script type="text/javascript">
$(function(){
	//跳转表单页面
	$('#btnAddInfoForm').on('click',function(){
		infoFormDialog("");	
	});
	//绑定查询按钮事件
	$("#btnSearch").click(function () {                
		bindList(0);
	});
	
	bindList(0);
 	setAutoSearch('.searchCondition',bindList,0);
	//关闭iframe
	$('#btnCloseIframe').click(function() {
	 	$(".close").click();			
	});
	
	//添加
    $('#btnAdd').click(function (){
    	//$('#clearDiv input').val('');
    	//$('#frm').bootstrapValidator('validate');
    	//$('#clearDiv select[0]').attr('selected',true);
		$('.dis-mask-wrap').addClass('dis-mask-wrapac');
    });
    
    //关闭
    $('#btnClose').click(function (){
		$('.dis-mask-wrap').removeClass('dis-mask-wrapac');
		document.location.reload();
	});  	
	
	
	
	loadCountry();
	$('#selEntityType').val($('#hidEntityType').val());
	$('#selIsFinancial').val($('#hidIsFinancial').val());
	$('#selCountry').val($('#hidCountry').val());
	$('#selIncorporationPlace').val($('#hidIncorporationPlace').val());
	
	function loadCountry(){
		$.ajax({
            type: "post",
            url : "${base}/console/country/langListJson.do?datestr="+ new Date().getTime(),
            data: {},
            async: false,
            dataType: "json",
            success: function (json, textStatus) {
               if (json != undefined && json.result == true) {
					  var data = JSON.parse(json.countryJson);
					  var html = "";
					  $.each(data, function(i, n) {
						 html += "<option value='"+n.id+"'>" + n.name + "</option>";
					  });
					  $('#selIncorporationPlace').empty().append(html);                                       
					  $('#selCountry').empty().append(html);
              	 }
            }
       	});
	}

		//表单验证
		$('#frm').bootstrapValidator({
			feedbackIcons : {
				valid : 'glyphicon glyphicon-ok',
				invalid : 'glyphicon glyphicon-remove',
				validating : 'glyphicon glyphicon-refresh'
			},
			fields : {
				companyNameSc : {
					validators : {
						notEmpty : {
							message : "[@lang_res k='console.ifafirm.detail.form.label.companyName'/](简体) [@lang_res k='global.empty.tip'/]"
						}
					}
				},
				companyNameTc : {
	                validators : {
	                    notEmpty : {
	                        message : "[@lang_res k='console.ifafirm.detail.form.label.companyName'/](繁体) [@lang_res k='global.empty.tip'/]"
	                    }
	                }
	            },
	            companyNameEn : {
	                validators : {
	                    notEmpty : {
	                        message : "[@lang_res k='console.ifafirm.detail.form.label.companyName'/](英文) [@lang_res k='global.empty.tip'/]"
	                    }
	                }
	            },
				registerNo : {
					validators : {
						notEmpty : {
							message : "[@lang_res k='console.ifafirm.detail.form.label.registerNo'/] [@lang_res k='global.empty.tip'/]"
						}
					}
				},
				incorporationPlace : {
					validators : {
						notEmpty : {
							message : "[@lang_res k='console.ifafirm.detail.form.label.incorporationPlace'/] [@lang_res k='global.empty.tip'/]"
						}
					}
				},
				registeredAddress:{
					validators : {
						notEmpty : {
							message : "[@lang_res k='console.ifafirm.detail.form.label.registeredAddress'/] [@lang_res k='global.empty.tip'/]"
						}
					}
				}
			}
		}).on('success.form.bv', function(e) {
			e.preventDefault();
			savefrom();
		});

	
	//保存
	function savefrom() {
		var id = $('#hidIfaFirmId').val();
		var companyNameSc = $('#txtCompanyNameSc').val();
		var entityType = $('#selEntityType').find('option:selected').val();
		var registerNo = $('#txtRegisterNo').val();
		var isFinancial = $('#selIsFinancial').find('option:selected').val();
		var giin = $('#txtGiin').val();
		var naturePurpose = $('#txtNaturePurpose').val();
		var incorporationDate = $('#dtIncorporationDate').val();
		var incorporationPlace = $('#selIncorporationPlace').val();
		var registeredAddress = $('#txtRegisteredAddress').val();
		var mailingAddress = $('#txtMailingAddress').val();
		var country = $('#selCountry').val();
		var website = $('#txtWebsite').val();
		var companyNameTc = $('#txtCompanyNameTc').val();
		var companyNameEn = $('#txtCompanyNameEn').val();
		var firmLogo = $('#imgPathFile').val();
	
		//console.log(firmLogo);//上传控件问题：1）上传完，看不到图，路径要转换； 2）打开编辑，能看到图，但再保存时，读取不到val()，所以原图片路径会被置空
		if (!firmLogo || firmLogo=="")
		    firmLogo = $('#firmLogo').val();
		    
		
		var postData = { 'id':id,'companyNameSc': companyNameSc, 'entityType': entityType, 'registerNo': registerNo, 'isFinancial': isFinancial, 'giin': giin, 'incorporationPlace': incorporationPlace, 'registeredAddress': registeredAddress, 'mailingAddress': mailingAddress, 'country': country,
		                 'naturePurpose':naturePurpose,'incorporationDate':incorporationDate,'website':website,
		                 'companyNameTc':companyNameTc,'companyNameEn':companyNameEn,'firmLogo':firmLogo
		                 }; 
		var params = $("#frm").serialize();
		params = decodeURIComponent(params,true);
		
       	$.ajax({
            type: "post",
            url : "${base}/console/distributorifafirm/saveFirminfo.do?datestr="+ new Date().getTime(),
           	data: params,
            //data: JSON.stringify(params),
            async: false,
            dataType: "json",
            success: function (data, textStatus) {
               var result = data.result;
               if(result==true){ 
               		layer.msg("[@lang_res k='global.success.save'/]", { icon: 1, time: 2000 });
               		$('#btnSave').attr('disabled','disabled');
               		$('.dis-mask-wrap').removeClass('dis-mask-wrapac');
               		//bindList(0);
               		document.location.reload();
               }else
               		layer.msg("[@lang_res k='global.failed.save'/]", { icon: 0, time: 2000 });
               }
       	});
	}
	
	
	
    
});

//分页绑定Table数据
function bindList(curPage){
	var ifafirmName = $("#txtIfafirmName").val();
	$.ajax({
		type : 'post',
		datatype : 'json',
		url : '${base}/console/distributorifafirm/listJson.do?',
		data : {
			'ifafirmName' : ifafirmName,
			'page' : curPage+1,
			'rows' : pageSize,
			'order' : 'desc'
		},
		success : function(json) {
			var total = json.total;
			var table = json.rows;
			$("#infoList tbody tr:gt(0)").empty();
			if(!!total){
				$("#dataTotal").html(total)
			}else{
				$("#dataTotal").html(0)
			}
			  var tr = "";
              var list = json.rows;
              $.each(list, function (index, array) { //遍历json数据列					
                  var id = array['id'] == null ? "" : array['id'];
              	  var ifafirmName = array['ifafirmName'] == null ? "" : array['ifafirmName'];
              	 //modify by rawang 20170614
              	 var firmLogo = array['ifafirm']['firmLogo'] == null? "" : array['ifafirm']['firmLogo'];
              	 var entityType = array['ifafirm']['entityType'] == null ? "" : array['ifafirm']['entityType'];
				 switch (entityType) {
                    case ('1'):
                    entityType = "[@lang_res k='entityType.option.1'/]";
                        break;
                    case ('2'):
                    entityType = "[@lang_res k='entityType.option.2'/]";
                        break;
                    case ('3'):
                    entityType = "[@lang_res k='console.ifafirm.list.select.entityType.3'/]";
                        break;
                    case ('4'):
                    entityType = "[@lang_res k='console.ifafirm.list.select.entityType.4'/]";
                        break;
                    case ('5'):
                    entityType = "[@lang_res k='console.ifafirm.list.select.entityType.5'/]";
                        break;
                    default:
                     entityType = '';
                 }
                 var registerNo = array['ifafirm']['registerNo'] == null ? "" : array['ifafirm']['registerNo'];
                 var website = array['ifafirm']['website'] == null ? "" : array['ifafirm']['website'];
              	 var incorporationPlace = array['ifafirm']['incorporationPlace'] == null ? "" : array['ifafirm']['incorporationPlace']; 
              	 var ifaFirmId= array['ifafirm']['id'] == null ? "" : array['ifafirm']['id'];
                 var url = '${base}/console/distributorifafirm/ifafirmFundList.do?ifaFirmId=' + ifaFirmId;
                  
                  tr += '<tr><td>'
                  	  + '<img id="imgFile" style="width:90px;height:35px;" src="${base}'+firmLogo+'" value="'+firmLogo+'"/>' + '</td><td>'
                      + ifafirmName + '</td><td>'
                      + entityType + '</td><td>'
                      + registerNo + '</td><td>'
                      + website + '</td><td>'
                      + incorporationPlace + '</td><td>'			//+ '</td><td>'暂时不需要此功能 modify by rawang 业务逻辑不对，表弃用
                      //+ '<a target="_blank" href="'+url+'">[@lang_res k='console.distributor.ifafirm.actingProducts'/]</a> '
                      + "<a href=\"javascript:void(0);\" onclick=\"deleteIfaFirm('"+id+"')\">" +'[@lang_res  k='console.ifa.team.add.remove'/]'+ "</a>"
                      + '</td></tr>';
              });
             $("#infoList tbody").append(tr);
			
		  	$("#pagination").pagination(total, {
                 callback: pageselectCallback,
                 numDetail: '',
                 items_per_page: pageSize,
                 num_display_entries: 4,
                 current_page: curPage,
                 num_edge_entries: 2
           	});
		}
	})
	//回调
    function pageselectCallback(page_id, jq) {
        bindList(page_id);
    }
}	
//点击删除
function deleteIfaFirm(id){
	//alert(id);
	layer.confirm("[@lang_res  k='pipeline.clientType.delete.confirm'/]", 
			{title:"[@lang_res  k='console.ifa.team.add.remove'/]", 
		icon: 3,
		btn: [langMutilForJs["global.confirm"],langMutilForJs["global.cancel"]]},
		function (index){
			$.ajax({
				url:'${base}/console/distributorifafirm/del.do?id='+id,
				type:'post',
				dataType:'json',
				data:{
					id: id,
				},
				success:function(data){
					if(data.result){
						layer.msg("[@lang_res  k='global.delete.success'/]",{icon:2,time:1000},
							function(){
								bindList(0);
								closeTab();
							}
						);
					}
		        },
				error:function(){
					
				}
			});
	    	
	    	layer.close(index);
	});
}

</script>

